#!/bin/bash

IN_FILE="$1"
OUT_FILE="$2"

cat "$IN_FILE" |\
    perl -0777 -pe "s/\n\n____\n(((?!____|====).)+)\n____\n\n([[]quote, [^\n]+[]]\n____\n)/\n\n\3\1\n\n/gs" |\
    perl -0777 -pe "s/\n\n____\n(((?!____|====).)+)\n____\n\n([[]quote, [^\n]+[]]\n____\n)/\n\n\3\1\n\n/gs" |\
    perl -0777 -pe "s/\n\n____\n(((?!____|====).)+)\n____\n\n([[]quote, [^\n]+[]]\n____\n)/\n\n\3\1\n\n/gs" |\
    perl -0777 -pe "s/\n\n____\n(((?!____|====).)+)\n____\n\n([[]quote, [^\n]+[]]\n____\n)/\n\n\3\1\n\n/gs" |\
    perl -0777 -pe "s/\n\n____\n(((?!____|====).)+)\n____\n\n([[]quote, [^\n]+[]]\n____\n)/\n\n\3\1\n\n/gs" |\
    perl -0777 -pe "s/\n\n____\n(((?!____|====).)+)\n____\n\n([[]quote, [^\n]+[]]\n____\n)/\n\n\3\1\n\n/gs" |\
    perl -0777 -pe "s/\n\n____\n(((?!____|====).)+)\n____\n\n([[]quote, [^\n]+[]]\n____\n)/\n\n\3\1\n\n/gs" |\
    perl -0777 -pe "s/\n\n____\n(((?!____|====).)+)\n____\n\n([[]quote, [^\n]+[]]\n____\n)/\n\n\3\1\n\n/gs" |\
    perl -0777 -pe "s/\n\n____\n(((?!____|====).)+)\n____\n\n([[]quote, [^\n]+[]]\n____\n)/\n\n\3\1\n\n/gs" |\
    perl -0777 -pe "s/\n\n____\n(((?!____|====).)+)\n____\n\n([[]quote, [^\n]+[]]\n____\n)/\n\n\3\1\n\n/gs" |\
    perl -0777 -pe "s/\n\n____\n(((?!____|====).)+)\n____\n\n([[]quote, [^\n]+[]]\n____\n)/\n\n\3\1\n\n/gs" |\
    perl -0777 -pe "s/\n\n____\n(((?!____|====).)+)\n____\n\n([[]quote, [^\n]+[]]\n____\n)/\n\n\3\1\n\n/gs" |\
    perl -0777 -pe "s/\n\n____\n(((?!____|====).)+)\n____\n\n([[]quote, [^\n]+[]]\n____\n)/\n\n\3\1\n\n/gs" |\
    perl -0777 -pe "s/\n\n____\n(((?!____|====).)+)\n____\n\n([[]quote, [^\n]+[]]\n____\n)/\n\n\3\1\n\n/gs" |\
    perl -0777 -pe "s/\n\n____\n(((?!____|====).)+)\n____\n\n([[]quote, [^\n]+[]]\n____\n)/\n\n\3\1\n\n/gs" |\
    perl -0777 -pe "s/\n\n____\n(((?!____|====).)+)\n____\n\n([[]quote, [^\n]+[]]\n____\n)/\n\n\3\1\n\n/gs" |\
    perl -0777 -pe "s/\n\n____\n(((?!____|====).)+)\n____\n\n([[]quote, [^\n]+[]]\n____\n)/\n\n\3\1\n\n/gs" |\
    perl -0777 -pe "s/\n\n____\n(((?!____|====).)+)\n____\n\n([[]quote, [^\n]+[]]\n____\n)/\n\n\3\1\n\n/gs" |\
    perl -0777 -pe "s/\n\n____\n(((?!____|====).)+)\n____\n\n([[]quote, [^\n]+[]]\n____\n)/\n\n\3\1\n\n/gs" |\
    perl -0777 -pe "s/\n\n____\n(((?!____|====).)+)\n____\n\n([[]quote, [^\n]+[]]\n____\n)/\n\n\3\1\n\n/gs" |\
    perl -0777 -pe "s/\n\n____\n(((?!____|====).)+)\n____\n\n([[]quote, [^\n]+[]]\n____\n)/\n\n\3\1\n\n/gs" |\
    perl -0777 -pe "s/\n\n____\n(((?!____|====).)+)\n____\n\n([[]quote, [^\n]+[]]\n____\n)/\n\n\3\1\n\n/gs" |\
    perl -0777 -pe "s/\n\n____\n(((?!____|====).)+)\n____\n\n([[]quote, [^\n]+[]]\n____\n)/\n\n\3\1\n\n/gs" |\
    perl -0777 -pe "s/\n\n____\n(((?!____|====).)+)\n____\n\n([[]quote, [^\n]+[]]\n____\n)/\n\n\3\1\n\n/gs" |\
    perl -0777 -pe "s/\n\n____\n(((?!____|====).)+)\n____\n\n([[]quote, [^\n]+[]]\n____\n)/\n\n\3\1\n\n/gs" |\
    perl -0777 -pe "s/\n\n____\n(((?!____|====).)+)\n____\n\n([[]quote, [^\n]+[]]\n____\n)/\n\n\3\1\n\n/gs" |\
    perl -0777 -pe "s/\n\n____\n(((?!____|====).)+)\n____\n\n([[]quote, [^\n]+[]]\n____\n)/\n\n\3\1\n\n/gs" |\
    perl -0777 -pe "s/\n\n____\n(((?!____|====).)+)\n____\n\n([[]quote, [^\n]+[]]\n____\n)/\n\n\3\1\n\n/gs" |\
    perl -0777 -pe "s/\n\n____\n(((?!____|====).)+)\n____\n\n([[]quote, [^\n]+[]]\n____\n)/\n\n\3\1\n\n/gs" |\
    perl -0777 -pe "s/\n\n____\n(((?!____|====).)+)\n____\n\n([[]quote, [^\n]+[]]\n____\n)/\n\n\3\1\n\n/gs" |\
    perl -0777 -pe "s/\n\n____\n(((?!____|====).)+)\n____\n\n([[]quote, [^\n]+[]]\n____\n)/\n\n\3\1\n\n/gs" |\
    perl -0777 -pe "s/\n\n____\n(((?!____|====).)+)\n____\n\n([[]quote, [^\n]+[]]\n____\n)/\n\n\3\1\n\n/gs" |\
    perl -0777 -pe "s/\n\n____\n(((?!____|====).)+)\n____\n\n([[]quote, [^\n]+[]]\n____\n)/\n\n\3\1\n\n/gs" |\
    perl -0777 -pe "s/\n\n____\n(((?!____|====).)+)\n____\n\n([[]quote, [^\n]+[]]\n____\n)/\n\n\3\1\n\n/gs" |\
    perl -0777 -pe "s/\n\n____\n(((?!____|====).)+)\n____\n\n([[]quote, [^\n]+[]]\n____\n)/\n\n\3\1\n\n/gs" |\
    perl -0777 -pe "s/\n\n____\n(((?!____|====).)+)\n____\n\n([[]quote, [^\n]+[]]\n____\n)/\n\n\3\1\n\n/gs" |\
    perl -0777 -pe "s/\n\n____\n(((?!____|====).)+)\n____\n\n([[]quote, [^\n]+[]]\n____\n)/\n\n\3\1\n\n/gs" |\
    perl -0777 -pe "s/\n\n____\n(((?!____|====).)+)\n____\n\n([[]quote, [^\n]+[]]\n____\n)/\n\n\3\1\n\n/gs" |\
    perl -0777 -pe "s/\n\n____\n(((?!____|====).)+)\n____\n\n([[]quote, [^\n]+[]]\n____\n)/\n\n\3\1\n\n/gs" |\
    perl -0777 -pe "s/\n\n____\n(((?!____|====).)+)\n____\n\n([[]quote, [^\n]+[]]\n____\n)/\n\n\3\1\n\n/gs" |\
    perl -0777 -pe "s/\n\n____\n(((?!____|====).)+)\n____\n\n([[]quote, [^\n]+[]]\n____\n)/\n\n\3\1\n\n/gs" > "$OUT_FILE"

